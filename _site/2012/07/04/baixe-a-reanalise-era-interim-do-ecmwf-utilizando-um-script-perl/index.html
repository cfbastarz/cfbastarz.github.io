<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Baixe a reanálise ERA Interim do ECMWF utilizando um script Perl « Carlos Frederico Bastarz</title>
  <meta name="description" content="Recentemente precisei baixar alguns dados da Renálise do ERA Interim para estudo. No site, é oferecido um formulário onde pode-se selecionar o período, variá...">

  <link rel="stylesheet" href="/cfbastarz/css/main.css">
  <link rel="canonical" href="http://localhost:4000/cfbastarz/2012/07/04/baixe-a-reanalise-era-interim-do-ecmwf-utilizando-um-script-perl/">
  <link rel="alternate" type="application/rss+xml" title="Carlos Frederico Bastarz" href="http://localhost:4000/cfbastarz/feed.xml" />
</head>


  <body>

    <div class="header-placeholder"></div>
<header class="header">
  <div class="wrapper">
    <div id="sidebar-toggle">TOC</div>
    <a class="site-title" href="/cfbastarz/">Carlos Frederico Bastarz</a>
    <nav class="site-nav">
      
        
        <a class="page-link" href="/cfbastarz/about/">Sobre</a>
      
        
        <a class="page-link" href="/cfbastarz/category/">Categorias</a>
      
    </nav>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">Baixe a reanálise ERA Interim do ECMWF utilizando um script Perl</h1>
    <p class="post-meta">Jul 4, 2012 • {"login"=>"craftmind", "email"=>"cfbastarz@gmail.com", "display_name"=>"cfbastarz", "first_name"=>"", "last_name"=>""} • {"_edit_last"=>"13386696", "_oembed_981ef17f46309303870b1a4befc3d6e8"=>"{{unknown}}", "_oembed_3cddc4a9c2dd08305241bd1913614d33"=>"{{unknown}}", "_oembed_4f608624495cc2e67e3af24444c0af1f"=>"{{unknown}}", "_oembed_24c976c0f40095655ba0fc4c5e60d58f"=>"{{unknown}}"}</p>
  </header>

  <article class="post-content">
    <p>Recentemente precisei baixar alguns dados da Renálise do ERA Interim para estudo. No site, é oferecido um formulário onde pode-se selecionar o período, variáveis, níveis etc. Com essa seleção, um script server-side processa o seu pedido, gera um arquivo em GRIB e, dependendo do seu pedido, converte o GRIB em NETCDF. Perfeito! Mas e se você quiser baixar tudo? e uma quantidade colossal de dados e com certeza vai demandar uma quantidade colossal de espaço e tempo. Portanto, vamos considerar que você queira baixar um período grande, contendo alguns anos, níveis e variáveis, algo suficiente para que você queira e precise fazer um script.</p>
<p>O primeiro passo, portanto, é entrar em <a href="http://data-portal.ecmwf.int/data/d/interim_daily/" target="_blank">http://data-portal.ecmwf.int/data/d/interim_daily/ </a>e depois clicar no link indicado na imagem abaixo:</p>
<p><a href="http://craftmind.wordpress.com/2012/07/04/baixe-a-reanalise-era-interim-do-ecmwf-utilizando-um-script-perl/screen-shot-2012-07-04-at-9-34-02-pm/" rel="attachment wp-att-1692"><img class="aligncenter size-full wp-image-1692" title="Screen Shot 2012-07-04 at 9.34.02 PM" src="/cfbastarz/assets/screen-shot-2012-07-04-at-9-34-02-pm.png" alt="" width="545" height="86" /></a>Você será redirecionado para uma nova página contendo um script simples em Python e outras duas opções em Perl, que são as opções que nós iremos usar.</p>
<p><a href="http://craftmind.wordpress.com/2012/07/04/baixe-a-reanalise-era-interim-do-ecmwf-utilizando-um-script-perl/screen-shot-2012-07-04-at-9-42-42-pm/" rel="attachment wp-att-1693"><img class="aligncenter size-full wp-image-1693" title="Screen Shot 2012-07-04 at 9.42.42 PM" src="/cfbastarz/assets/screen-shot-2012-07-04-at-9-42-42-pm.png" alt="" width="545" height="368" /></a>Os scripts que nos interessam estão mais ao final da página. Mas para utilizá-los, nós necessitaremos de alguns softwares instalados no computador. Vamos precisar do Perl (uma linguagem de programação em scripts modular) e de dois módulos básicos: o libdate-calc-perl e o DataServer do ECMWF que deve ser baixado no link indicado pelo retângulo vermelho da imagem acima.</p>
<p>Para instalar estes pacotes no seu Linux (vou considerar o Ubuntu), faça o seguinte:</p>
<p><strong>1) Instale o Perl:</strong></p>
<pre>$ sudo apt-get install perl</pre>
<p><strong>2) Instale o módulo libdate-calc-perl:</strong></p>
<pre>$ sudo apt-get install libdate-calc-perl</pre>
<p><strong>3) Baixe o módulo DataServer do ECMWF em <a href="http://tigge.ecmwf.int/ECMWF_DataServer.tar" target="_blank">http://tigge.ecmwf.int/ECMWF_DataServer.tar</a></strong></p>
<p><strong>4) Desempacote o arquivo <a href="http://tigge.ecmwf.int/ECMWF_DataServer.tar" target="_blank">ECMWF_DataServer.tar</a> na pasta /usr/share/perl/&lt;versao_do_seu_perl&gt;:</strong></p>
<pre>$ sudo tar -xvf <a href="http://tigge.ecmwf.int/ECMWF_DataServer.tar" target="_blank">ECMWF_DataServer.tar</a> -C /usr/share/perl/&lt;versao_do_seu_perl&gt;</pre>
<p>Se você estiver utilizando o Mac OS X (vou considerar o Lion), você precisará apenas instalar o módulo DataServer do ECMWF na pasta /System/Library/Perl/5.12:</p>
<pre>$ sudo tar -xvf ECMWF_DataServer.tar -C /System/Library/Perl/5.12</pre>
<p>Feito isto, copie o segundo script em Perl (é o último script da página) da página que você abriu (a página que contém os scripts) e cole em um arquivo vazio no seu computador:</p>
<pre>#!/usr/bin/perl -Ipath_to_where_ECMWF::DataServer_is_installed
use ECMWF::DataServer;
use Date::Calc qw(Add_Delta_Days Delta_Days);
use strict;

my $client = ECMWF::DataServer-&gt;new(
    portal =&gt; 'http://data-portal.ecmwf.int/data/d/dataserver/',
    token  =&gt; 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
    email  =&gt; 'yyyyyyyyyyyyyyyyyyyyyyyyyyyyy',
);

# This is the start date. Modify as required
my ($year, $month, $day) = (2009, 01, 01);
# This is the end date. Modify as required
my @enddate = (2009, 01, 02);

while (Delta_Days(@date, @enddate) &gt;= 0) {

  my $date = sprintf("%d-%02d-%02d", $year, $month, $day);

  $client-&gt;retrieve( 
    dataset  =&gt; "interim_daily",
    step     =&gt; "0",
    levtype  =&gt; "pl",
    type     =&gt; "an",
    param    =&gt; "130.128",
    levelist =&gt; "500/1000",
    area     =&gt; "60/-120/30/-60",
    date     =&gt; "$date",
    time     =&gt; "00/12",
    target   =&gt; "data_${date}.grib",
    );

  # move to next day
  ($year, $month, $day) = Add_Delta_Days($year, $month, $day, 1);

}</pre>
<p>Para este script, devem ser observadas as sequências 'xxxxxx...' e 'yyyyy...' para as variáveis "token" e "email", respectivamente. Estas são variáveis utilizadas pelo módulo DataServer do ECMWF para autenticar a sua conexão ao servidor do centro. Quando você abrir esta página, será gerada automaticamente um token (uma espécie de senha) específica para o email que você forneceu anteriormente. Portanto, esses 'yyyyy...' e esses 'xxxxx...' não aparecem na página, mas sim o seu email (que você de ter informado) e um token gerado automaticamente. Uma outra informação importante, é que para executar corretamente o script, você precisar corrigir uma falha. Veja:</p>
<pre>$ ./script_perl.pl
Global symbol "@date" requires explicit package name at ./script_perl.pl line 17.
Execution of ./script_perl.pl aborted due to compilation errors.</pre>
<p>Ou seja, a variável "@date" é usada, mas não está declarada. Então, para consertarmos isso, basta acrescentar a linha em negrito abaixo dentro do seu script:</p>
<pre>my ($year, $month, $day) = (2009, 01, 01);
<strong>my @date = (2009, 01, 01);</strong></pre>
<p>Com isso, será possível executar novamente o script e baixar os seus dados. Você pode alterar o script de acordo com as suas necessidades, bastando seguir a sintaxe do <a href="http://www.ecmwf.int/services/archive/" target="_blank">MARS</a>, que é um programa com linguagem própria criado para coletar os dados dentro do banco de dados do ECMWF.</p>
<p>O script corrigido fica assim:</p>
<pre>#!/usr/bin/perl -Ipath_to_where_ECMWF::DataServer_is_installed
use ECMWF::DataServer;
use Date::Calc qw(Add_Delta_Days Delta_Days);
use strict;

my $client = ECMWF::DataServer-&gt;new(
    portal =&gt; 'http://data-portal.ecmwf.int/data/d/dataserver/',
    token  =&gt; 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
    email  =&gt; 'yyyyyyyyyyyyyyyyyyyyyyyyyyyyy',
);

# This is the start date. Modify as required
my ($year, $month, $day) = (2009, 01, 01);
my @date = (2009, 01, 01);
# This is the end date. Modify as required
my @enddate = (2009, 01, 02);

while (Delta_Days(@date, @enddate) &gt;= 0) {

  my $date = sprintf("%d-%02d-%02d", $year, $month, $day);

  $client-&gt;retrieve( 
    dataset  =&gt; "interim_daily",
    step     =&gt; "0",
    levtype  =&gt; "pl",
    type     =&gt; "an",
    param    =&gt; "130.128",
    levelist =&gt; "500/1000",
    area     =&gt; "60/-120/30/-60",
    date     =&gt; "$date",
    time     =&gt; "00/12",
    target   =&gt; "data_${date}.grib",
    );

  # move to next day
  ($year, $month, $day) = Add_Delta_Days($year, $month, $day, 1);

}</pre>
<p>Com tudo corrigido, o script mostra as seguintes saídas:</p>
<p>[caption id="attachment_1694" align="aligncenter" width="545"]<a href="http://craftmind.wordpress.com/2012/07/04/baixe-a-reanalise-era-interim-do-ecmwf-utilizando-um-script-perl/screen-shot-2012-07-04-at-10-10-42-pm/" rel="attachment wp-att-1694"><img class="size-full wp-image-1694" title="Screen Shot 2012-07-04 at 10.10.42 PM" src="/cfbastarz/assets/screen-shot-2012-07-04-at-10-10-42-pm.png" alt="" width="545" height="79" /></a> (Clique para ampliar)[/caption]
<p>Em meus testes, notei que o servidor do ECMWF é um pouco instável, portanto você poderá experimentar alguns "Connection Timeout", por parte do módulo DataServer do ECMWF, responsável pela autenticação da conexão entre o seu computador e o servidor do ECMWF.</p>
<pre>500 read timeout at ECMWF/DataServer.pm line 35.</pre>
<p>É isso!</p>

  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="https://s.gravatar.com/avatar/1573e6ecaedd8b5a641dce5d582efd56?s=80" alt="Carlos Frederico Bastarz">
  <div class="col-box-title name">Carlos Frederico Bastarz</div>
  <p>Tecnologista CPTEC/INPE.</p>
  <p class="contact">
    
    
    
    <a href="mailto:cfbastarz@gmail.com">Email</a>
    
    <a href="https://github.com/cfbastarz">GitHub</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/cfbastarz/archivers/Equa%C3%A7%C3%A3o-de-an%C3%A1lise">Equação De Análise</a></li>
    
      <li><a class="post-link" href="/cfbastarz/2018/10/16/copiando-o-caminho-atual-pwd-no-shell-sem-utilizar-o-mouse/">Copiando o caminho atual (pwd) no Shell sem utilizar o mouse</a></li>
    
      <li><a class="post-link" href="/cfbastarz/2018/10/16/copiando-o-caminho-atual-pwd-no-shell-sem-utilizar-o-mouse/">Copiando o caminho atual (pwd) no Shell sem utilizar o mouse</a></li>
    
      <li><a class="post-link" href="/cfbastarz/2018/10/15/memoria/">Memória</a></li>
    
      <li><a class="post-link" href="/cfbastarz/2018/10/15/memoria/">Memória</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>

        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2019 Carlos Frederico Bastarz
</div>
</footer>

<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script>
<script src="/cfbastarz/js/easybook.js"></script>


  </body>

</html>
